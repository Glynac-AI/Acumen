name: CI/CD for Acumen Web
on:
  push:
    branches: ["main"]
    paths:
      - "**"
  pull_request:
    branches: ["main"]
    paths:
      - "**"

env:
  PRODUCT_VERSION: "latest" # or: "latest"
  IMAGE_TAG: ${{ github.ref_name }}-${{ github.sha }}
  DOCKER_IMAGE: image-reg.ops.glynac.ai/glynac-fe/acumen

permissions:
  contents: read
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: checkout
        uses: actions/checkout@v4

      - name: Login to Harbor
        uses: docker/login-action@v3
        with:
          registry: image-reg.ops.glynac.ai
          username: admin
          password: ${{ secrets.HARBOR_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile
          push: true
          tags: |
            ${{ env.DOCKER_IMAGE }}:${{ env.IMAGE_TAG }}
            ${{ env.DOCKER_IMAGE }}:latest

      - name: Save image tag
        run: echo "IMAGE_TAG=${{ env.IMAGE_TAG }}" >> $GITHUB_ENV

  deploy:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup `nomad`
        uses: hashicorp/setup-nomad@main
        id: setup
        with:
          version: ${{ env.PRODUCT_VERSION }}

      - name: Update Nomad deployment with image tag
        run: |
          sed -i "s|IMAGE_TAG_PLACEHOLDER|${{ env.IMAGE_TAG }}|g" nomad/acumen.hcl

      - name: Request deployment to Nomad
        env:
          NOMAD_ADDR: ${{ vars.NOMAD_ADDR }}
          NOMAD_TOKEN: ${{ secrets.NOMAD_TOKEN }}
        run: nomad job run nomad/acumen.hcl

  notify:
    runs-on: self-hosted
    needs: [build, deploy]
    if: always()

    steps:
      - name: Send Telegram Notification
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          TELEGRAM_THREAD_ID: ${{ secrets.TELEGRAM_THREAD_ID }}
          IMAGE_TAG: ${{ needs.build.outputs.IMAGE_TAG }}
          JOB_STATUS: ${{ needs.deploy.result }}
        run: |
          PIPELINE_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          BRANCH="${{ github.ref_name }}"
          ACTOR="${{ github.actor }}"

          if [ "$JOB_STATUS" = "success" ]; then
            STATUS="SUCCESS"
            EMOJI="‚úÖ"
          elif [ "$JOB_STATUS" = "cancelled" ]; then
            STATUS="CANCELLED"
            EMOJI="‚ö†Ô∏è"
          else
            STATUS="FAILED"
            EMOJI="‚ùå"
          fi

          MESSAGE=$(printf "üöÄ Acumen Strategy Service Deployment\n\nüì¶ Image: %s\nüåø Branch: %s\nüë§ Triggered by: %s\nüìä Status: %s %s\n\nüîó %s" \
            "$IMAGE_TAG" \
            "$BRANCH" \
            "$ACTOR" \
            "$EMOJI" \
            "$STATUS" \
            "$PIPELINE_URL")

          if [ -z "$TELEGRAM_THREAD_ID" ]; then
            curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage" \
              -d "chat_id=${TELEGRAM_CHAT_ID}" \
              --data-urlencode "text=${MESSAGE}"
          else
            curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage" \
              -d "chat_id=${TELEGRAM_CHAT_ID}" \
              -d "message_thread_id=${TELEGRAM_THREAD_ID}" \
              --data-urlencode "text=${MESSAGE}"
          fi
